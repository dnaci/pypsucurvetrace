#!/usr/bin/env python3

# This file is part of curvetracePPSPy, a toolbox for curve tracing using programmable Voltcraft PPS power supplies.
#
# curvetracePPSPy is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# curvetracePPSPy is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with ruediPy.  If not, see <http://www.gnu.org/licenses/>.


# imports:
import time
import math
import configparser
import argparse
import numpy as np
from termcolor import colored
import lib.powersupply_PPS as powersupply_PPS


#############################################################
# function to print output both to console and to data file #
#############################################################

def printit(text,f='',comm=''):
	print(text)
	if f:
		if len(comm):
			text = comm + ' ' + text
		print(text,file=f)
		f.flush()
	return


###########################
# connect to power supply #
###########################

def connect_PSU(configPSU,label):
	
	if len(configPSU[label]['COMPORT']) == 0:
		print('COM port for power supply ' + label + 'empty. Leaving ' + label + ' uN2onfigured.')
		PSU.VMAX = 0.0
		PSU.VMIN = 0.0
		PSU.IMAX = 0.0
		PSU.TSETTLE = 0.0
		PSU.MODEL = 'NONE'
		PSU.connected = False

	else:
		# connect to PSU:
		print ('Connecting to power supply ' + label + '...')
		PSU = powersupply_PPS.PPS(port=configPSU[label]['COMPORT'], reset=False, prom=None)
		PSU.output(False) # make sure it is turned off

		# determine minimum voltage of the PSU:
		PSU.VMIN = float(configPSU[label]['VOLTAGE_MIN'])

		# determine settle time:
		PSU.TSETTLE = float(configPSU[label]['SETTLE_SECONDS'])

		# turn on PSU with zero output:
		PSU.voltage(PSU.VMIN)
		PSU.current(0)
		PSU.output(True)

		PSU.label = label		

		PSU.connected = True

		# show summary
		print ('* Type: ' + PSU.MODEL)
		print ('* Min. voltage output: ' + str(PSU.VMIN) + ' V')
		print ('* Max. voltage output: ' + str(PSU.VMAX) + ' V')
		print ('* Max. current output: ' + str(PSU.IMAX) + ' A')
		print ('* Settle time: ' + str(PSU.TSETTLE) + ' s')
		print ()

	PSU.PMAX = math.floor(PSU.VMAX*PSU.IMAX)

	return PSU



###############################
# configure PSU test settings #
###############################

def configure_test_PSU(PSU,configDUT):
	
	if PSU.connected == False:
		print ('\n' + PSU.label + ' is not connected (or connection is not configured).')
		PSU.configured = False
	else:
	
		if configDUT:
			# take configuration from DUT config file:
			PSU.VSTART = float(configDUT['VSTART'])
			PSU.VEND   = float(configDUT['VEND'])
			PSU.N      = int(configDUT['N'])
			PSU.ILIMIT = float(configDUT['IMAX'])
			PSU.PLIMIT = float(configDUT['PMAX'])
			PSU.POLARITY = float(configDUT['POLARITY'])

		else:

			print ('\n' + 'configure ' + PSU.label + ' test settings:')

			try:
				PSU.VSTART = float(input('* ' + PSU.label + ' start voltage (V): '))
			except ValueError:
				print ('  Invalid input!')

			try:
				PSU.VEND = float(input('* ' + PSU.label + ' end voltage (V): '))
			except ValueError:
				print ('  Invalid input!')

			try:
				PSU.N = int(input('* ' + PSU.label + ' number of voltage steps: '))
			except ValueError:
				print ('  Invalid input!')		

			try:
				PSU.ILIMIT = float(input('* ' + PSU.label + ' maximum allowed current (A): '))
			except ValueError:
				print ('  Invalid input!')

			try:
				PSU.PLIMIT = float(input('* ' + PSU.label + ' maximum allowed power (W): '))
			except ValueError:
				print ('  Invalid input!')


			try:
				pol = (input('* OPTIONAL: ' + PSU.label + ' polarity of outputs -- N: normal / I: inverted [default=N]: '))
			except ValueError:
				print ('  Using default: normal polarity.')
				pol = 'N'
			if pol.upper() == 'I':
				PSU.POLARITY = -1
			else:
				PSU.POLARITY = 1;

		PSU.configured = True

	return PSU



###############################
# configure PSU idle settings #
###############################

def configure_idle_PSU(PSU,configDUT):
	
	if PSU.configured:

		if configDUT:
			# take configuration from DUT config file:
			PSU.VIDLE = float(configDUT['VIDLE'])
			PSU.IIDLE = float(configDUT['IIDLE'])

		else:
			print ('\n' + 'configure ' + PSU.label + ' idle settings:')
			try:
				PSU.VIDLE = float(input('* ' + PSU.label + ' idle voltage (V): '))
			except ValueError:
				print ('  Invalid input!')
			try:
				PSU.IIDLE = float(input('* ' + PSU.label + ' idle current (A): '))
			except ValueError:
				print ('  Invalid input!')

	return PSU


################
# turn off PSU #
################

def turn_off_PSU(PSU):
	if PSU.configured:
		try:
			PSU.current(0)
			PSU.voltage(PSU.VMIN)
			print(PSU.label + ' turned off.')
		except:
			print('Could not turn off ' + PSU.label + '!')


################
# main program #
################

# parse input arguments (if any):
parser = argparse.ArgumentParser(description='Use programmable Voltcraft PPS power supplies for I/V curve tracing of electronic devices.')
parser.add_argument('-c', help='configuration file with test parameters (name/path)')
args = parser.parse_args()

# Say Hello:
print('\n')
print('***** CurvetracePPS')
print('***** Python program to use Voltcraft PPS power supplies for I-V curve tracing of electronic parts')
print('***** Disclaimer: NO WARRANTIES OF ANY KIND!!!')
print('***** Disclaimer: Users are advised to study the code in order to understand how this program works.')
print('\n')

# read PSU config file:
configPSU = configparser.ConfigParser()
configPSU.read('config_PSU.txt')

# read DUT configPSU file (if any):
configDUT = []
if args.c:
	print ('Reading DUT configuration in file ' + args.c + '...\n')
	configDUT = configparser.ConfigParser()
	configDUT.read(args.c)

# connect to PSUs:
PSU1 = connect_PSU(configPSU,'PSU1');
PSU2 = connect_PSU(configPSU,'PSU2');

# ask for sample name:
samplename = ''
while not samplename:
    samplename = input('Enter sample name / label: ')
    samplename = samplename.strip()

# start logfile:
logfilename = samplename + '.dat'

logfile = open(logfilename,'w')
if logfile:
    print('\nLogging output to ' + logfilename + '...')
else:
    print('Could not open log file!')
    exit()

# configure voltage values / current and power limits:
if 'PSU1' in configDUT:
	PSU1 = configure_test_PSU (PSU1,configDUT['PSU1'])
else:
	PSU1 = configure_test_PSU (PSU1,None)
if 'PSU2' in configDUT:
	PSU2 = configure_test_PSU (PSU2,configDUT['PSU2'])
else:
	PSU2 = configure_test_PSU (PSU2,None)

# check if at least one of the power supplies is configured:	
if PSU1.configured == False:
	if PSU2.configured == False:
		print('No power suplly configured. Good bye.')
		exit()

# set up repeats:
if 'EXTRA' in configDUT:
	N_rep = int(configDUT['EXTRA']['NREP'])
else:
	try:
		N_rep = int(input('\nOPTIONAL: Number of repeats per reading [default=1]: '))
	except ValueError:
		print ('  Using default: single reading.')
		N_rep = 1
if N_rep <= 0:
	raise ValueError('Number of repeats must be positive.')

# set up idle time between readings:
if 'EXTRA' in configDUT:
	T_idle    = int(configDUT['EXTRA']['IDLESECS'])
else:
	try:
		T_idle = float(input('\nOPTIONAL: idle time between readings (s) [default=0]: '))
	except ValueError:
		print ('  Using default: no idle time.')
		T_idle = 0.0
if T_idle < 0:
	raise ValueError('Idle time must not be negative.')

# set up pre-heat time between readings:
if 'EXTRA' in configDUT:
	T_preheat    = int(configDUT['EXTRA']['PREHEATSECS'])
else:
	try:
		T_preheat = float(input('\nOPTIONAL: pre-heat time before starting the test (s) [default=0]: '))
	except ValueError:
		print ('  Using default: no pre-heating.')
		T_preheat = 0.0
if T_preheat < 0:
	raise ValueError('Pre-heat time must not be negative.')

# set up idle conditions (for pre-heat or idle between readings)
if (T_idle > 0.0) or (T_preheat > 0.0):
	if PSU1.configured:
		if 'PSU1' in configDUT:
			PSU1 = configure_idle_PSU (PSU1,configDUT['PSU1'])
		else:
			PSU1 = configure_idle_PSU (PSU1,None)
	if PSU2.configured:
		if 'PSU2' in configDUT:
			PSU2 = configure_idle_PSU (PSU2,configDUT['PSU2'])
		else:
			PSU2 = configure_idle_PSU (PSU2,None)

# check voltage / power / current limits (and fix where possible and necessary):
print ('\nChecking voltage / current / power limits...')
for p in [PSU1,PSU2]:
	if p.VSTART < p.VMIN:
		print ('  ' + p.label + ': Adjusting start voltage to min. value possible with the power supply (' + str(p.VMIN) + ' V).')
		p.VSTART = p.VMIN
	if p.VSTART > p.VMAX:
		print ('  ' + p.label + ': Adjusting start voltage to max. value possible with the power supply (' + str(p.VMAX) + ' V).')
		p.VSTART = p.VMAX
	if p.VEND < p.VMIN:
		print ('  ' + p.label + ': Adjusting end voltage to min. value possible with the power supply (' + str(p.VMIN) + ' V).')
		p.VEND = p.VMIN
	if p.VEND > p.VMAX:
		print ('  ' + p.label + ': Adjusting end voltage to max. value possible with the power supply (' + str(p.VMAX) + ' V).')
		p.VEND = p.VMAX
	if p.VEND == p.VSTART:
		print ('  ' + p.label + ': Same start and end voltage! Using single step (N = 1).')
		p.N = 1
	if p.ILIMIT > p.IMAX:
		print ('  ' + p.label + ': Adjusting current limit to max. value possible with the power supply (' + str(p.IMAX) + ' A).')
		p.ILIMIT = p.IMAX
	if p.PLIMIT > p.PMAX:
		print ('  ' + p.label + ': Adjusting power limit to max. value possible with the power supply (' + str(p.PMAX) + ' W).')
		p.PLIMIT = p.PMAX
	if p.N < 1:
		print ('  ' + p.label + ': Number of voltage steps with power supply (' + str(p.VMAX) + ' must be positive. Adjusting to N = 1.')
		p.N = 1

# Print summary of test setup:
print('\nTest setup:')
printit('* Sample: ' + samplename,logfile,'%')
for p in [PSU1, PSU2]:
	printit ('* ' + p.label + ':',logfile,'%')
	if p.configured == False:
		printit ('   not configured',logfile,'%')
	else:
		if p.N == 1:
			printit ('   voltage output = ' + str(p.VSTART) + ' V',logfile,'%')
		else:
			printit ('   voltage output = ' + str(p.VSTART) + ' V ... ' + str(p.VEND) + ' V (' + str(p.N) + ' steps)',logfile,'%')
		printit ('   current limit = ' + str(p.ILIMIT) + ' A',logfile,'%')
		printit ('   power limit = ' + str(p.PLIMIT) + ' W',logfile,'%')
		if p.POLARITY == 1:
			printit ('   polarity: normal',logfile,'%')
		else:
			printit ('   polarity: inverted',logfile,'%')

printit ('* Repeats per reading = ' + str(N_rep),logfile,'%')
if T_idle == 0.0:
	printit ('* No idle time between measurements',logfile,'%')
else:
	printit ('* Idle time between measurements: ' + str(T_idle) + ' seconds',logfile,'%')
if T_preheat == 0.0:
	printit ('* No pre-heating before measurements',logfile,'%')
else:
	printit ('* Pre-heat time before measurements (at idle conditions): ' + str(T_preheat) + ' seconds',logfile,'%')
if (T_idle > 0.0) or (T_preheat > 0.0):
	for p in [PSU1, PSU2]:
		if p.configured == False:
			printit ('* ' + p.label + '* Idle / pre-heat conditions not configured',logfile,'%')
		else:
			printit ('* ' + p.label + ' idle / pre-heat voltage limit = ' + str(p.VIDLE) + ' V',logfile,'%')
			printit ('* ' + p.label + ' idle / pre-heat current limit = ' + str(p.IIDLE) + ' A',logfile,'%')


# Ask if okay to start the test
input ('\nReady? Press ENTER to start testing or CTRL+C to abort...')

# Run the test:

print('\n')

printit ('Column 1:  PSU1 nominal voltage setting (V)',logfile,'%')
printit ('Column 2:  PSU1 nominal current setting (A)',logfile,'%')
printit ('Column 3:  PSU1 voltage measurement (V)',logfile,'%')
printit ('Column 4:  PSU1 current measurement (I)',logfile,'%')
printit ('Column 5:  PSU1 limiter flag',logfile,'%')
printit ('Column 6:  PSU2 nominal voltage setting (V)',logfile,'%')
printit ('Column 7:  PSU2 nominal current setting (A)',logfile,'%')
printit ('Column 8:  PSU2 voltage measurement (V)',logfile,'%')
printit ('Column 9:  PSU2 current measurement (I)',logfile,'%')
printit ('Column 10: PSU2 limiter flag',logfile,'%')

print('\n')

try:

	if T_preheat > 0.0:
		
		print ('Pre-heating...\n')

		# set outputs to zero (to avoid overshoot)
		for p in [PSU1, PSU2]:
			if p.configured:
				p.voltage(p.VMIN)
				p.current(0)

		# set idle conditions:
		Tsettle = 0.0
		for p in [PSU1, PSU2]:
			if p.configured:
				p.voltage(p.VIDLE)
				p.current(p.IIDLE)
				if p.TSETTLE > Tsettle:
					Tsettle = p.TSETTLE
		time.sleep(Tsettle) # wait for stable conditions

		# wait pre-heat time:	
		time.sleep(T_preheat)

		# set outputs to zero (to avoid overshoot when starting next measurement)
		for p in [PSU1, PSU2]:
			if p.configured:
				p.voltage(p.VMIN)
				p.current(0)

	print ('Test started...\n')

	for V2 in np.linspace(PSU2.VSTART,PSU2.VEND,PSU2.N):

		if PSU2.configured:
			# Determine PSU2 current limit:
			if V2 > 0.0:
				I2LIM = min (PSU2.ILIMIT,PSU2.PLIMIT/V2)
			else:
				I2LIM = PSU2.ILIMIT
			
			# set PSU2 current limit:
			PSU2.current(I2LIM)
			PSU2.voltage(V2)
			time.sleep(PSU2.TSETTLE) # wait for stable conditions

		for V1 in np.linspace(PSU1.VSTART,PSU1.VEND,PSU1.N):

			# init measurement values		
			V1MEAS = []
			I1MEAS = 0.0
			LIMIT1 = 0
			V2MEAS = 0.0
			I2MEAS = 0.0
			LIMIT2 = 0

			# measurement loop:
			for i in range(N_rep):

				if T_idle > 0.0:
					# set outputs to zero (to avoid overshoot)
					for p in [PSU1, PSU2]:
						if p.configured:
							p.voltage(p.VMIN)
							p.current(0)

					# set idle conditions:
					Tsettle = 0.0
					for p in [PSU1, PSU2]:
						if p.configured:
							p.voltage(p.VIDLE)
							p.current(p.IIDLE)
							if p.TSETTLE > Tsettle:
								Tsettle = p.TSETTLE
					time.sleep(Tsettle) # wait for stable conditions

					# wait idle time:	
					time.sleep(T_idle)

					# set outputs to zero (to avoid overshoot when starting next measurement)
					for p in [PSU1, PSU2]:
						if p.configured:
							p.voltage(p.VMIN)
							p.current(0)

					# return to required PSU2 output:
					if PSU2.configured:
						PSU2.current(I2LIM)
						PSU2.voltage(V2)
						time.sleep(PSU2.TSETTLE) # wait for stable conditions

				# Determine PSU1 current limit:
				if V1 > 0.0:
					I1LIM = min (PSU1.ILIMIT,PSU1.PLIMIT/V1)
				else:
					I1LIM = PSU1.ILIMIT

				# set up PSU1 measurement conditions:
				if PSU1.configured:
					PSU1.current(I1LIM) # set current limit at PSU1
					PSU1.voltage(V1) # set voltage at PSU1
					time.sleep(PSU1.TSETTLE) # wait for stable conditions at PSU and DUT

				# read PSU output voltages and currents:
				r = []
				for p in [PSU1, PSU2]:
					if p.configured:
						r.append(p.reading())
					else:
						r.append([0.0,0.0,'NONE'])
				
				V1MEAS.append(r[0][0])
				# V1MEAS = V1MEAS + r[0][0];
				I1MEAS = I1MEAS + r[0][1];
				V2MEAS = V2MEAS + r[1][0];
				I2MEAS = I2MEAS + r[1][1];
				if r[0][2] == 'CC':
					LIMIT1 = LIMIT1 + 1
				if r[1][2] == 'CC':
					LIMIT2 = LIMIT2 + 1

			# Determine median or mean of repeated readings:
			V1MEAS = numpy.median(V1MEAS)
			# V1MEAS = V1MEAS / N_rep
			I1MEAS = I1MEAS / N_rep
			V2MEAS = V2MEAS / N_rep
			I2MEAS = I2MEAS / N_rep

			# Parse limiter flags:
			if LIMIT1 > 0:
				LIMIT1 = 1
			else:
				LIMIT1 = 0
			if LIMIT2 > 0:
				LIMIT2 = 1
			else:
				LIMIT2 = 0

			# Print results:
			printit ( str(V1*PSU1.POLARITY) + ' ' + str(I1LIM*PSU1.POLARITY) + ' ' + str(V1MEAS*PSU1.POLARITY) + ' ' + str(I1MEAS*PSU1.POLARITY) + ' ' + str(int(LIMIT1)) + ' ' + str(V2*PSU2.POLARITY) + ' ' + str(V2MEAS*PSU2.POLARITY) + ' ' + str(I2MEAS*PSU2.POLARITY) + ' ' + str(int(LIMIT2)) , logfile )

	print ('Test completed.')
	for p in [PSU1, PSU2]:
		turn_off_PSU(p)

except:
	print ('\nOooops, something went wrong during testing! Trying to turn off the PSUs...\n')
	for p in [PSU1, PSU2]:
		turn_off_PSU(p)
	raise
